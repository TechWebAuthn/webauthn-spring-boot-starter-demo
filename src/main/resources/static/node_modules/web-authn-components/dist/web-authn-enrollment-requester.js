const t={};export class WebAuthnEnrollmentRequester extends HTMLElement{constructor(){super(),this.root=this.attachShadow({mode:"open"}),this._onFormSubmitListener=this._onFormSubmit.bind(this),this.enrollmentStartUrl="/api/registration/start",this.enrollmentFinishUrl="/api/registration/finish",this.fetchOptions={method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}}static get observedAttributes(){return["label","input-type","input-name","button-text"]}connectedCallback(){this.update(),this.root.querySelector("form").addEventListener("submit",this._onFormSubmitListener)}disconnectedCallback(){this.root.querySelector("form").removeEventListener("submit",this._onFormSubmitListener)}attributeChangedCallback(t,e,n){if(!this.root.innerHTML)return;if(n===e)return;const r=this.root.querySelector("label"),i=this.root.querySelector("input"),o=this.root.querySelector("button");switch(t){case"label":r.textContent=n||this.label;break;case"button-text":o.textContent=n||this.buttonText;break;case"input-type":i.type=n||this.inputType;break;case"input-name":i.name=n||this.inputName}}update(){this.root.innerHTML||(this.root.innerHTML=`\n        <form part="form">\n          <label part="label" for="authn-enrollment-token">${this.label}</label>\n          <input part="input" id="authn-enrollment-token" type="${this.inputType}" name="${this.inputName}" />\n          <button part="button" type="submit">${this.buttonText}</button>\n        </form>\n      `)}get label(){return this.getAttribute("label")||"Enrollment token"}set label(t){this.setAttribute("label",t)}get buttonText(){return this.getAttribute("button-text")||"Enroll device"}set buttonText(t){this.setAttribute("button-text",t)}get inputType(){return this.getAttribute("input-type")||"text"}set inputType(t){this.setAttribute("input-type",t)}get inputName(){return this.getAttribute("input-name")||"registration-add-token"}set inputName(t){this.setAttribute("input-name",t)}async _getPublicKeyCredentialCreateOptionsDecoder(){if("function"==typeof this.publicKeyCredentialCreateOptionsDecoder)return this.publicKeyCredentialCreateOptionsDecoder;if("function"==typeof t.publicKeyCredentialCreateOptionsDecoder)return t.publicKeyCredentialCreateOptionsDecoder;const{decodePublicKeyCredentialCreateOptions:e}=await import("./utils/parse.js");return t.publicKeyCredentialCreateOptionsDecoder=e,t.publicKeyCredentialCreateOptionsDecoder}async _getRegisterCredentialEncoder(){if("function"==typeof this.registerCredentialEncoder)return this.registerCredentialEncoder;if("function"==typeof t.registerCredentialEncoder)return t.registerCredentialEncoder;const{encodeRegisterCredential:e}=await import("./utils/parse");return t.registerCredentialEncoder=e,t.registerCredentialEncoder}async _onFormSubmit(t){t.preventDefault(),this.dispatchEvent(new CustomEvent("enrollment-requested"));const e=new FormData(t.target),n=this.root.querySelector("input"),r=e.get(n.name);try{const t=await fetch(this.enrollmentStartUrl,{...this.fetchOptions,body:JSON.stringify({registrationAddToken:r})}),{status:e,registrationId:n,publicKeyCredentialCreationOptions:i}=await t.json();if(!t.ok)throw new Error(e||"Could not successfuly start enrollment");const o=await this._getPublicKeyCredentialCreateOptionsDecoder(),s=await navigator.credentials.create({publicKey:o(i)});this.dispatchEvent(new CustomEvent("enrollment-created"));const a=await this._getRegisterCredentialEncoder(),l=await fetch(this.enrollmentFinishUrl,{...this.fetchOptions,body:JSON.stringify({registrationId:n,credential:a(s),userAgent:window.navigator.userAgent})});if(!l.ok)throw new Error("Could not successfuly complete enrollment");const u=await l.json();this.dispatchEvent(new CustomEvent("enrollment-finished",{detail:u}))}catch(t){this.dispatchEvent(new CustomEvent("enrollment-error",{detail:{message:t.message}}))}}}customElements.define("web-authn-enrollment-requester",WebAuthnEnrollmentRequester);
